<%- include('header', {seoDetails}) %>

<section class="page-title-section top-position1 bg-img cover-background left-overlay-secondary" data-overlay-dark="85" data-background="/assets/img/banner/page-title-01.jpg">
    <div class="container">                
        <h1><%= categoryName ? categoryName + ' Products' : 'Our Products' %></h1>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/products">Products</a></li>
            <% if (categoryName) { %>
                <li><%= categoryName %></li>
            <% } else { %>
                <li>Products</li>
            <% } %>
        </ul>                
    </div>
</section>

<!-- CATEGORY FILTER TABS
================================================== -->
<% if (categories && categories.length > 0) { %>
<section style=" padding: 40px 0; margin-bottom: 30px;">
    <div class="container">
        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; max-width: 1200px; margin: 0 auto;">
            <button onclick="filterProducts('all')" class="category-tab active" data-category="all" style="padding: 0px 14px; background: var(--primary-color); border: 2px solid var(--primary-color); border-radius: 25px; color: white; text-decoration: none; font-weight: 500; font-size: 14px; height:40px; transition: all 0.3s ease; cursor: pointer;">All Products</button>
            <% categories.forEach(category => { %>
                <button onclick="filterProducts('<%= category._id %>')" class="category-tab" data-category="<%= category._id %>" style="padding: 0px 14px; background: white; border: 2px solid #e9ecef; border-radius: 25px; color: #6c757d; text-decoration: none; font-weight: 500; font-size: 14px; transition: all 0.3s ease; cursor: pointer;"><%= category.name %></button>
            <% }) %>
        </div>
    </div>
</section>
<% } %>

<!-- PRODUCTS GRID
================================================== -->
<style>
    /* Image Placeholder */
    .image-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(198, 164, 70, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .image-placeholder i {
        font-size: 25px;
        color: #c6a446;
    }
    
    .blog-img {
        position: relative;
        width: 100%;
        padding-top: 75%; /* Maintain aspect ratio */
        overflow: hidden;
    }
    
.category-name{
    color: #FC5220 !important;
}

    .category-name:hover{
        color: #59612a !important;
    }

    .blog-img img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        max-height: none !important;
        object-fit: cover;
    }
    .products-section{
        padding-top: 0px !important;
    }
</style>

<section class="products-section" >
    <div class="container">
        <div class="row mt-n1-9">
            <% if (products && products.length > 0) { %>
                <% products.forEach((item, index) => { %>
                    <div class="col-md-6 col-lg-4 mt-1-9 wow fadeInUp product-item" data-category="<%= item.category ? item.category._id : 'uncategorized' %>" data-wow-delay="<%= (index % 3 + 1) * 100 + 100 %>ms">
                        <article class="card card-style04 h-100">
                            <div class="blog-img position-relative overflow-hidden rounded-top">
                                <% if (item.arrays && item.arrays.arrayOne && item.arrays.arrayOne[0]) { %>
                                    <img src="<%= S3_BASE_URL + item.arrays.arrayOne[0] %>" class="rounded-top" alt="<%= item.title || 'Product Image' %>">
                                <% } else { %>
                                    <div class="image-placeholder">
                                        <i class="fa-solid fa-image"></i>
                                    </div>
                                <% } %>
                            </div>
                            <div class="card-body position-relative pt-2-6 pb-1-9 pb-xl-2-6 px-1-9 px-xl-2-4">
                                <% if (item.postDate) { 
                                    const dateParts = item.postDate.split(' ');
                                    const day = dateParts[0];
                                    const month = dateParts[1];
                                %>
                                <div class="post-date">
                                    <span class="mb-0 d-block lh-1 display-22 display-xl-17"><%= day %></span>
                                    <span class="d-block display-31"><%= month %></span>
                                </div>
                                <% } %>
                                <div class="mb-3">
                                    <% if (item.category && item.category.name) { %>
                                        <a href="/product/<%= item.seoDetails.slug %>" class="text-uppercase category-name fw-bold display-31"><%= item.category.name %></a>
                                    <% } else { %>
                                        <a href="/product/<%= item.seoDetails.slug %>" class="text-uppercase fw-bold display-31">Product</a>
                                    <% } %>
                                </div>
                                <h4 class="mb-0"><a href="/product/<%= item.seoDetails.slug %>"><%= item.title || 'Untitled Product' %></a></h4>
                            </div>
                        </article>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="col-12 text-center py-5">
                    <p class="display-28">No products available at the moment.</p>
                </div>
            <% } %>
        </div>
    </div>
</section>


<script>
// Product Filtering Function
function filterProducts(categoryId) {
    // Update active tab
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.style.background = 'white';
        tab.style.borderColor = '#e9ecef';
        tab.style.color = '#6c757d';
    });
    
    // Highlight active tab
    const activeTab = document.querySelector(`[data-category="${categoryId}"]`);
    if (activeTab) {
        activeTab.classList.add('active');
        activeTab.style.background = 'var(--primary-color)';
        activeTab.style.borderColor = 'var(--primary-color)';
        activeTab.style.color = 'white';
    }
    
    // Filter products
    const productItems = document.querySelectorAll('.product-item');
    let visibleCount = 0;
    
    productItems.forEach(item => {
        const itemCategory = item.getAttribute('data-category');
        
        if (categoryId === 'all' || itemCategory === categoryId) {
            item.style.display = 'block';
            item.style.opacity = '0';
            item.style.transform = 'translateY(20px)';
            
            // Smooth fade-in animation
            setTimeout(() => {
                item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                item.style.opacity = '1';
                item.style.transform = 'translateY(0)';
            }, 50);
            
            visibleCount++;
        } else {
            item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            item.style.opacity = '0';
            item.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                item.style.display = 'none';
            }, 300);
        }
    });
    
    // Update URL without page refresh
    const newUrl = categoryId === 'all' ? '/products' : `/products?category=${categoryId}`;
    window.history.pushState({ category: categoryId }, '', newUrl);
    
    // Update page title
    const categoryName = activeTab ? activeTab.textContent : 'All Products';
    document.title = `${categoryName} - Passary Refractories`;
    
    console.log(`Filtered to ${categoryName}: ${visibleCount} products visible`);
}

// Handle browser back/forward buttons
window.addEventListener('popstate', function(event) {
    const urlParams = new URLSearchParams(window.location.search);
    const category = urlParams.get('category') || 'all';
    filterProducts(category);
});

// Initialize filter based on URL on page load
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const category = urlParams.get('category') || 'all';
    
    if (category !== 'all') {
        filterProducts(category);
    }
});
</script>

<%- include('footer') %>