<style>
    .gallery-container {
        position: relative;
        width: 100%;
    }
    
    .gallery-thumb {
        width: calc(33.333% - 14px);
        margin-bottom: 20px;
        display: inline-block;
        vertical-align: top;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .gallery-thumb.loaded {
        opacity: 1;
    }
    
    .gallery-thumb img {
        width: 100%;
        height: auto;
        display: block;
    }
    
    @media (max-width:992px) {
        .gallery-container {
            max-width: 800px;
            margin: 2px auto;
        }
        .gallery-thumb {
            width: calc(50% - 15px);
            margin-bottom: 30px;
        }
    }
    
    @media (max-width:700px) {
        .gallery-container {
            max-width: 500px;
            margin: 2px auto;
        }
        .gallery-thumb {
            width: 100%;
            margin-bottom: 30px;
        }
    }
    
    @media (max-width:500px) {
        .gallery-container {
            max-width: 500px;
            margin: 2px auto;
        }
        .gallery-thumb {
            width: 100%;
            margin-bottom: 14px !important;
        }
    }
  
    .thumbnail-container {
        position: relative;
        width: 100%;
    }
    
    .thumbnail-image {
        width: 100%;
        height: 230px !important;
        object-fit: cover;
        display: block;
    }
    
    .play-button {
        position: absolute;
        display: flex;
        justify-content: center;
        align-self: center;
        font-size: 40px;
        color: white;
        border: 2px solid white;
        height: 72px;
        width: 72px;
        border-radius: 50%;
        cursor: pointer;
        top: 34%;
        left: 42%;
    }
</style>



      	<!-- Start main-content -->
          <section class="page-title" style="background-image: url(/assets/images/background/page-title-bg.png);">
            <div class="auto-container">
                <div class="title-outer text-center">
                    <h1 class="title">Visual Stories</h1>
                    <ul class="page-breadcrumb">
                        <li><a href="/">Home</a></li>
                        <li>gallery</li>
                    </ul>
                </div>
            </div>
        </section>
<section style="padding: 10px 0;">
    <div class="container" style="padding: 30px 10px;">
        <div class="filter-tabs-scroll">
            <div class="filter-tabs-inner" style="text-align: center; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px;">
                <button onclick="filterGallery('all')" class="gallery-tab theme-btn btn-style-one active" data-filter="all">All</button>
                <% if (gallery && Array.isArray(gallery)) { %>
                    <% gallery.forEach((album) => { %>
                        <% if (album.galleryType === "IMAGE" && album.images && album.images.length > 0) { %>
                            <button onclick="filterGallery('<%= album.title.toLowerCase() %>')" class="gallery-tab theme-btn btn-style-one" data-filter="<%= album.title.toLowerCase() %>"><%= album.title %></button>
                        <% } %>
                    <% }); %>
                    <% 
                    // Check if there are any videos
                    const hasVideos = gallery.some(album => album.galleryType === "VIDEO" && album.videos && Array.isArray(album.videos) && album.videos.some(video => video.link && video.link !== ''));
                    if (hasVideos) { 
                    %>
                        <button onclick="filterGallery('videos')" class="gallery-tab theme-btn btn-style-one" data-filter="videos">Videos</button>
                    <% } %>
                <% } %>
            </div>
        </div>
    </div>
</section>

<div class="gallery-area gallery-page masonry" style="padding-bottom: 120px;">
    <div class="container">
        <div class="gallery-itmes">
            <div class="rows">
                <!-- Gallery Container -->
                <div class="gallery-container state-gallery">
                    <% if (gallery && Array.isArray(gallery)) { %>
                        <% gallery.slice().reverse().forEach((album) => { %>
                            <% if (album.galleryType === "IMAGE" && album.images && Array.isArray(album.images) && album.images.length > 0) { %>
                                <% 
                                    const imageBase = typeof S3_BASE_URL !== 'undefined' && S3_BASE_URL 
                                        ? S3_BASE_URL.replace(/\/$/, '') + '/' 
                                        : 'https://technolitics-s3-bucket.s3.ap-south-1.amazonaws.com/websitebuilder-s3-bucket/';
                                    const albumFilter = album.title.toLowerCase();
                                %>
                                <% album.images.slice().reverse().forEach((image) => { %>
                                    <div class="gallery-thumb image-item popup-trigger" data-type="image" data-src="<%= imageBase + image %>" data-title="<%= albumFilter %>">
                                        <img src="<%= imageBase + image %>" 
                                             alt="<%= album.title %>" style="width: 100%;" />
                                    </div>
                                <% }); %>
                            <% } %>
                            <% if (album.galleryType === "VIDEO" && album.videos && Array.isArray(album.videos) && album.videos.length > 0) { 
                                function convertToEmbedUrl(url) {
                                    if (!url || url === '') return '';
                                    let videoId = "";
                                    if (url.includes("youtu.be")) {
                                        videoId = url.split("youtu.be/")[1]?.split("?")[0];
                                    } else if (url.includes("youtube.com/watch")) {
                                        videoId = url.split("v=")[1]?.split("&")[0];
                                    }
                                    return videoId ? `https://www.youtube.com/embed/${videoId}` : "";
                                }
                                album.videos.forEach((video) => {
                                    if (video.link) {
                                        const embedUrl = convertToEmbedUrl(video.link);
                                        if (embedUrl) {
                            %>
                                <div class="gallery-thumb video-item popup-trigger" data-type="video" data-src="<%= embedUrl %>" data-title="videos" style="display:flex; flex-direction:column">
                                    <div class="thumbnail-container">
                                        <img src="https://img.youtube.com/vi/<%= embedUrl.split('/').pop() %>/0.jpg" 
                                             alt="<%= album.title %>" class="thumbnail-image" />
                                        <div class="play-button">â–¶</div>
                                    </div>
                                </div>
                            <%      }
                                    }
                                });
                            } %>
                        <% }); %>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Masonry Layout Function - Fills row by row
    function initMasonry() {
        const container = document.querySelector('.gallery-container');
        if (!container) return;
        
        const items = Array.from(container.querySelectorAll('.gallery-thumb:not([style*="display: none"])'));
        if (items.length === 0) return;
        
        // Get number of columns based on screen size
        let cols = 3;
        if (window.innerWidth <= 992 && window.innerWidth > 700) cols = 2;
        if (window.innerWidth <= 700) cols = 1;
        
        const gap = 20;
        const containerWidth = container.offsetWidth;
        const colWidth = (containerWidth - (gap * (cols - 1))) / cols;
        
        // Reset positioning
        items.forEach(item => {
            item.style.position = 'absolute';
            item.style.width = colWidth + 'px';
            item.style.left = '';
            item.style.top = '';
        });
        
        // Track column heights
        const colHeights = new Array(cols).fill(0);
        
        // Process items in order (row by row)
        items.forEach((item, index) => {
            // Find shortest column
            const shortestCol = colHeights.indexOf(Math.min(...colHeights));
            
            // Position item
            const left = shortestCol * (colWidth + gap);
            const top = colHeights[shortestCol];
            
            item.style.left = left + 'px';
            item.style.top = top + 'px';
            
            // Update column height
            const img = item.querySelector('img');
            if (img && img.complete) {
                colHeights[shortestCol] += img.offsetHeight + gap;
            } else if (img) {
                img.onload = function() {
                    colHeights[shortestCol] += img.offsetHeight + gap;
                    container.style.height = Math.max(...colHeights) + 'px';
                };
                // Fallback height estimate
                colHeights[shortestCol] += 300 + gap;
            } else {
                colHeights[shortestCol] += item.offsetHeight + gap;
            }
        });
        
        // Set container height
        container.style.height = Math.max(...colHeights) + 'px';
        container.style.position = 'relative';
        
        // Show items with fade-in
        items.forEach((item, index) => {
            setTimeout(() => {
                item.classList.add('loaded');
            }, index * 50);
        });
    }
    
    // Filter Gallery Functionality
    function filterGallery(filter) {
        const galleryItems = document.querySelectorAll('.gallery-thumb');
        const galleryTabs = document.querySelectorAll('.gallery-tab');
        
        // Update active tab
        galleryTabs.forEach(tab => {
            tab.classList.remove('active');
            if (tab.getAttribute('data-filter') === filter) {
                tab.classList.add('active');
            }
        });
        
        // Filter items
        galleryItems.forEach(item => {
            const itemTitle = item.getAttribute('data-title');
            if (filter === 'all') {
                item.style.display = 'block';
                if (item.classList.contains('video-item')) {
                    const title = item.querySelector('.video-title');
                    if (title) title.style.display = 'none';
                }
            } else if (filter === 'videos' && item.classList.contains('video-item')) {
                item.style.display = 'block';
                const title = item.querySelector('.video-title');
                if (title) title.style.display = 'block';
            } else if (filter !== 'videos' && itemTitle === filter && !item.classList.contains('video-item')) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });

        // Reinitialize masonry after filter
        setTimeout(() => {
            initMasonry();
        }, 100);

        // Reinitialize Media Items for Popup if function exists
        if (typeof initMediaItems === 'function') {
            initMediaItems();
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        // Wait for images to load
        const images = document.querySelectorAll('.gallery-thumb img');
        let loadedCount = 0;
        
        if (images.length === 0) {
            filterGallery('all');
            setTimeout(initMasonry, 100);
            return;
        }
        
        images.forEach(img => {
            if (img.complete) {
                loadedCount++;
                if (loadedCount === images.length) {
                    filterGallery('all');
                    setTimeout(initMasonry, 100);
                }
            } else {
                img.onload = function() {
                    loadedCount++;
                    if (loadedCount === images.length) {
                        filterGallery('all');
                        setTimeout(initMasonry, 100);
                    }
                };
            }
        });
        
        // Fallback timeout
        setTimeout(() => {
            filterGallery('all');
            initMasonry();
        }, 1000);
    });
    
    // Reinitialize on window resize
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            initMasonry();
        }, 250);
    });
</script>
