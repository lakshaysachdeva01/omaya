<%- include('header', {seoDetails}) %>

<% 
    // Determine the type and current item
    const currentItem = typeof venue !== 'undefined' && venue ? venue : (typeof stay !== 'undefined' && stay ? stay : (typeof dining !== 'undefined' && dining ? dining : null));
    const itemType = typeof venue !== 'undefined' && venue ? 'venue' : (typeof stay !== 'undefined' && stay ? 'stay' : (typeof dining !== 'undefined' && dining ? 'dining' : 'venue'));
    const typePath = itemType === 'venue' ? '/venue' : (itemType === 'stay' ? '/stay' : '/dining');
    const typeLabel = itemType === 'venue' ? 'Venue' : (itemType === 'stay' ? 'Stay' : 'Dining');
    
    // Extract YouTube video ID from currentItem.youtubeVideo
    let youtubeVideoId = '';
    if (currentItem && currentItem.youtubeVideo) {
        const youtubeUrl = currentItem.youtubeVideo;
        if (youtubeUrl.includes('youtu.be/')) {
            youtubeVideoId = youtubeUrl.split('youtu.be/')[1]?.split('?')[0] || '';
        } else if (youtubeUrl.includes('youtube.com/watch')) {
            youtubeVideoId = youtubeUrl.split('v=')[1]?.split('&')[0] || '';
        }
    }
%>

<style>
    /* Banner YouTube video player styles */
    .banner-section .banner-youtube-container {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        overflow: hidden;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        isolation: isolate;
        background: transparent !important;
        background-image: none !important;
    }
    
    .banner-section .banner-youtube-container iframe {
        width: 100%;
        height: 100%;
        border: none;
        pointer-events: none !important;
        -webkit-touch-callout: none;
        transform: translateZ(0) scale(1.6);
        -webkit-transform: translateZ(0) scale(1.6);
        transform-origin: center center;
        -webkit-transform-origin: center center;
        opacity: 1;
        position: relative;
        z-index: 1;
        filter: brightness(0.7);
        background-image: none !important;
        background: transparent !important;
        background-color: transparent !important;
        background-size: unset !important;
        background-position: unset !important;
        background-repeat: unset !important;
    }
    
    .banner-section .banner-youtube-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 99999 !important;
        pointer-events: auto !important;
        background: transparent;
        cursor: default !important;
    }
    
    /* Video overlay - separate element to ensure visibility */
    .banner-section .banner-youtube-container .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.1);
        z-index: 3 !important;
        pointer-events: none;
        display: block !important;
    }
    
    .banner-section .banner-youtube-container .youtube-overlay-blocker {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 100000 !important;
        pointer-events: auto !important;
        background: transparent !important;
        cursor: default !important;
        display: block !important;
    }
    
    .banner-section .banner-youtube-container:hover::before {
        pointer-events: auto !important;
        z-index: 99999 !important;
    }
    
    .banner-section .banner-youtube-container:hover .youtube-overlay-blocker {
        pointer-events: auto !important;
        z-index: 100000 !important;
    }
    
    .banner-section .banner-slide {
        position: relative;
    }
    
    .banner-section .content-box {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        -webkit-transform: translate(-50%, -50%);
        z-index: 100001 !important;
        text-align: center;
    }
    
    /* Page title breadcrumb styling */
    .banner-section .content-box .page-breadcrumb {
        list-style: none;
        padding: 0;
        margin: 20px 0 0 0;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .banner-section .content-box .page-breadcrumb li {
        display: inline-block;
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
    }
    
    .banner-section .content-box .page-breadcrumb li:not(:last-child)::after {
        content: '/';
        margin: 0 10px;
        color: rgba(255, 255, 255, 0.6);
    }
    
    .banner-section .content-box .page-breadcrumb li a {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: color 0.3s ease;
    }
    
    .banner-section .content-box .page-breadcrumb li a:hover {
        color: var(--theme-color1);
    }
</style>

<!-- banner section -->
<section class="banner-section">
    <div class="banner-slider">
        <div class="banner-slide">
            <% if (youtubeVideoId) { %>
                <div class="banner-youtube-container" id="detail-banner-youtube-player" style="width: 100%; height: 100%; filter: brightness(0.7); position: relative;">
                    <!-- YouTube Player will be initialized here -->
                    <div class="video-overlay"></div>
                    <div class="youtube-overlay-blocker"></div>
                </div>
            <% } else { %>
                <div class="banner-slide" style="background-image: url(<%= currentItem && currentItem.bannerImage ? currentItem.bannerImage : '/assets/images/background/page-title-bg.png' %>); background-size: cover; background-position: center; height: 100%;"></div>
            <% } %>
            <div class="content-box">
                <h1 class="title" style="color: #fff; font-size: 48px; margin-bottom: 10px;"><%= currentItem ? currentItem.title : typeLabel + ' Details' %></h1>
                <ul class="page-breadcrumb">
                    <li><a href="/">Home</a></li>
                    <li><a href="<%= typePath %>"><%= typeLabel %></a></li>
                    <li><%= currentItem ? currentItem.title : 'Details' %></li>
                </ul>
            </div>
        </div>
    </div>
</section>
<!-- End banner section -->

<!--Room Details Start-->
<section class="blog-details">
    <div class="container">
        <div class="row">
            <div class="col-xl-12 col-lg-12 product-details rd-page">
                <% if (currentItem && currentItem.detailImages && currentItem.detailImages.length > 0) { %>
                    <div class="row image-gallery-wrapper">
                        <div class="col-lg-10 col-md-8">
                            <div class="bxslider">
                                <% currentItem.detailImages.forEach((image, index) => { %>
                                    <div class="slider-content">
                                        <figure class="image-box popup-trigger" data-type="image" data-src="<%= image %>" data-title="<%= currentItem.title %>" style="cursor: pointer;">
                                            <img src="<%= image %>" alt="<%= currentItem.title %>">
                                        </figure>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4">
                            <div class="slider-pager">
                                <ul class="thumb-box">
                                    <% currentItem.detailImages.forEach((thumbImage, thumbIndex) => { %>
                                        <li>
                                            <a class="<%= thumbIndex === 0 ? 'active' : '' %>" data-slide-index="<%= thumbIndex %>" href="#">
                                                <figure><img src="<%= thumbImage %>" alt=""></figure>
                                            </a>
                                        </li>
                                    <% }); %>
                                </ul>
                            </div>
                        </div>
                    </div>
                <% } %>
                
                <div class="room-details__left">
                    <div class="wrapper">
                        <h3>Description</h3>
                        <% if (currentItem && currentItem.detailDescription) { %>
                            <% 
                                const paragraphs = currentItem.detailDescription.split('\n\n');
                                paragraphs.forEach(paragraph => {
                                    if (paragraph.trim()) {
                            %>
                                <p class="text"><%= paragraph.trim() %></p>
                            <% 
                                    }
                                });
                            %>
                        <% } else { %>
                            <p class="text">No description available.</p>
                        <% } %>
                        
                        <% if (currentItem && (currentItem.venueDetails || currentItem.stayDetails || currentItem.diningDetails)) { %>
                            <% const details = currentItem.venueDetails || currentItem.stayDetails || currentItem.diningDetails; %>
                            <div class="row justify-content-center">
                                <div class="col-xl-12">
                                    <div class="room-details__content-right mb-40 mt-20">
                                        <div class="room-details__details-box">
                                            <div class="row" style="display: flex; justify-content: space-between; ">
                                                <% if (details.roomSize) { %>
                                                    <div style="width: auto;">
                                                        <p class="text mb-0">Room Size</p>
                                                        <h6><%= details.roomSize %></h6>
                                                    </div>
                                                <% } %>
                                                <% if (details.bedType) { %>
                                                    <div style="width: auto;">
                                                        <p class="text mb-0">Bed Type</p>
                                                        <h6><%= details.bedType %></h6>
                                                    </div>
                                                <% } %>
                                                <% if (details.occupancy) { %>
                                                    <div style="width: auto;">
                                                        <p class="text mb-0">Occupancy</p>
                                                        <h6><%= details.occupancy %></h6>
                                                    </div>
                                                <% } %>
                                                <% if (details.category) { %>
                                                    <div style="width: auto;">
                                                        <p class="text mb-0">Category</p>
                                                        <h6><%= details.category %></h6>
                                                    </div>
                                                <% } %>
                                                <% if (details.cuisine) { %>
                                                    <div style="width: auto;">
                                                        <p class="text mb-0">Cuisine</p>
                                                        <h6><%= details.cuisine %></h6>
                                                    </div>
                                                <% } %>
                                                <% if (details.seating) { %>
                                                    <div style="width: auto;">
                                                        <p class="text mb-0">Seating</p>
                                                        <h6><%= details.seating %></h6>
                                                    </div>
                                                <% } %>
                                                <% if (details.timings) { %>
                                                    <div style="width: auto;">
                                                        <p class="text mb-0">Timings</p>
                                                        <h6><%= details.timings %></h6>
                                                    </div>
                                                <% } %>
                                                <% if (details.size) { %>
                                                    <div style="width: auto;">
                                                        <p class="text mb-0">Size</p>
                                                        <h6><%= details.size %></h6>
                                                    </div>
                                                <% } %>
                                                <% if (details.capacity && !details.seating) { %>
                                                    <div style="width: auto;">
                                                        <p class="text mb-0">Capacity</p>
                                                        <h6><%= details.capacity %></h6>
                                                    </div>
                                                <% } %>
                                                <% if (details.flooring) { %>
                                                    <div style="width: auto;">
                                                        <p class="text mb-0">Flooring</p>
                                                        <h6><%= details.flooring %></h6>
                                                    </div>
                                                <% } %>
                                                <% if (details.airConditioning) { %>
                                                        <div style="width: auto;">
                                                        <p class="text mb-0">Air Conditioning</p>
                                                        <h6><%= details.airConditioning %></h6>
                                                    </div>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% } %>
                    </div>
                    
                    <% if (currentItem && currentItem.features && currentItem.features.length > 0) { %>
                        <div class="mt-40">
                            <h4>Room Facilities</h4>
                            <div class="row room-facility-list mb-40">
                                <% currentItem.features.forEach((feature, index) => { %>
                                    <div class="col-sm-6 col-xl-4">
                                        <div class="list-one d-flex align-items-center me-sm-4 <%= index < currentItem.features.length - 1 ? 'mb-3' : '' %>">
                                            <div class="icon text-theme-color1 mr-10 flex-shrink-0">
                                                <i class="far fa-check-circle"></i>
                                            </div>
                                            <h6 class="title m-0"><%= feature %></h6>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    <% } %>
                    
                    <% if (currentItem && currentItem.paidServices && currentItem.paidServices.length > 0) { %>
                        <div class="mt-40">
                            <h4>Paid Services</h4>
                            <ul class="list-unstyled" style="list-style: none; padding-left: 0;">
                                <% currentItem.paidServices.forEach((service) => { %>
                                    <li style="margin-bottom: 10px; padding-left: 20px; position: relative;">
                                        <span style="position: absolute; left: 0; color: var(--theme-color1);">•</span>
                                        <span><%= service %></span>
                                    </li>
                                <% }); %>
                            </ul>
                        </div>
                    <% } %>
                    
                    <% if (currentItem && currentItem.view360) { %>
                        <div class="mt-40">
                            <h4>360° View</h4>
                            <div id="panorama-360" style="width: 100%; height: 650px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; background: #f4f6f8;">
                                <div class="panorama-preloader" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 10; background: #f4f6f8;">
                                    <div class="panorama-spinner"></div>
                                </div>
                            </div>
                        </div>
                    <% } %>
                    
                    <div class="d-sm-flex align-items-sm-center justify-content-sm-between pt-40 pb-40 border-top">
                        <h6 class="my-sm-0">Share Details</h6>
                        <div class="blog-details__social-list">
                            <a href="#"><i class="fa fa-x"></i></a>
                            <a href="#"><i class="fab fa-facebook"></i></a>
                            <a href="#"><i class="fab fa-pinterest-p"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                        </div>
                    </div>
                    
                    <div class="p-4 p-lg-5 bg-light">
                        <h4 class="mt-0">Send Us Your Question</h4>
                        <form id="contact_form" name="contact_form" class="" action="#" method="post">
                            <div class="row">
                                <div class="col-sm-6 col-xl-4">
                                    <div class="mb-3">
                                        <input name="form_name" class="form-control bg-white" type="text" placeholder="Enter Name" required>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-xl-4">
                                    <div class="mb-3">
                                        <input name="form_email" class="form-control bg-white required email" type="email" placeholder="Enter Email" required>
                                    </div>
                                </div>
                                <div class="col-xl-4">
                                    <div class="mb-3">
                                        <input name="form_phone" class="form-control bg-white required phone" type="tel" placeholder="Enter Phone" required>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <textarea name="form_message" class="form-control bg-white required" rows="5" placeholder="Enter Message" required></textarea>
                            </div>
                            <div class="mb-0">
                                <input name="form_botcheck" class="form-control" type="hidden" value="">
                                <button type="submit" class="theme-btn btn-style-one" data-loading-text="Please wait..."><span class="btn-title">Submit Comment</span></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<%- include('footer') %>

<style>
    /* Image gallery wrapper */
    .image-gallery-wrapper {
        margin-bottom: 30px;
    }
    
    /* Single image slider styles */
    .product-details .bxslider {
        margin-bottom: 0;
    }
    
    /* Make thumbnail container match slideshow height exactly */
    .product-details .image-gallery-wrapper .col-lg-10 {
        position: relative;
    }
    
    .product-details .image-gallery-wrapper .col-lg-2 {
        position: relative;
    }
    
    /* Prevent height from being 0 */
    .product-details .image-gallery-wrapper .col-lg-2[style*="height: 0"],
    .product-details .image-gallery-wrapper .col-lg-2[style*="height:0"] {
        height: auto !important;
    }
    
    .product-details .bxslider .slider-content {
        width: 100%;
    }
    
    .product-details .bxslider .slider-content .image-box {
        width: 100%;
        margin: 0;
    }
    
    .product-details .bxslider .slider-content .image-box img {
        width: 100%;
        height: auto;
        display: block;
    }
    
    /* Hide navigation arrows */
    .product-details .bx-controls-direction {
        display: none !important;
    }
    
.pnlm-controls-container{
    right: 10px !important;
    bottom: 10px !important;
    left: auto !important;
    top: auto !important;
}

    .product-details .bx-prev,
    .product-details .bx-next {
        display: none !important;
    }
    
    /* Thumbnails on right side - vertical layout with scroll */
    .product-details .slider-pager {
        padding-left: 0px;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        max-height: 100%;
    }
    
    .product-details .slider-pager .thumb-box {
        display: flex;
        flex-direction: column;
        gap: 10px;
        list-style: none;
        padding: 0;
        margin: 0;
        width: 100%;
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 5px;
    }
    
    /* Custom scrollbar for thumbnails */
    .product-details .slider-pager .thumb-box::-webkit-scrollbar {
        width: 4px;
    }
    
    .product-details .slider-pager .thumb-box::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .product-details .slider-pager .thumb-box::-webkit-scrollbar-thumb {
        background: var(--theme-color1);
        border-radius: 10px;
    }
    
    .product-details .slider-pager .thumb-box::-webkit-scrollbar-thumb:hover {
        background: #aa8453;
    }
    
    .product-details .slider-pager .thumb-box li {
        position: relative;
        display: block;
        width: 100%;
        margin: 0;
        flex-shrink: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
    }
    
    .product-details .slider-pager .thumb-box li a {
        position: relative;
        display: block;
        width: 100%;
        overflow: hidden;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .product-details .slider-pager .thumb-box li a:hover,
    .product-details .slider-pager .thumb-box li a.active {
        border-color: var(--theme-color1);
    }
    
    .product-details .slider-pager .thumb-box li a figure {
        margin: 0;
        padding: 0;
        width: 100%;
        height: auto;
        aspect-ratio: 4/3;
        position: relative;
        overflow: hidden;
    }
    
    .product-details .slider-pager .thumb-box li a figure img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
    
    .product-details .slider-pager .thumb-box li a:before {
        position: absolute;
        content: "";
        left: 0px;
        top: 0px;
        width: 100%;
        height: 100%;
        opacity: 0;
        background: rgba(211, 191, 119, 0.2);
        -webkit-transition: all 500ms ease;
        transition: all 500ms ease;
        z-index: 1;
        border-radius: 4px;
    }
    
    .product-details .slider-pager .thumb-box li a.active:before {
        opacity: 1;
    }
    
    @media (max-width: 991.98px) {
        .product-details .slider-pager {
            padding-left: 0;
            padding-top: 15px;
            padding-right: 0;
        }
        
        .product-details .slider-pager .thumb-box {
            flex-direction: row;
            flex-wrap: nowrap;
            max-height: none;
            overflow-x: auto;
            overflow-y: hidden;
            gap: 10px;
            padding-bottom: 5px;
        }
        
        .product-details .slider-pager .thumb-box li {
            width: 80px;
            flex-shrink: 0;
        }
        
        .product-details .slider-pager .thumb-box li a figure {
            height: 80px;
        }
    }
    
    /* Sidebar other items styling */
    .sidebar__post-list li {
        margin-bottom: 25px;
        padding-bottom: 25px;
        border-bottom: 1px solid #e0e4e8;
    }
    
    .sidebar__post-list li:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .sidebar__post-image {
  
        border-radius: 8px;
        overflow: hidden;
    }
    
    .sidebar__post-image img {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border-radius: 8px;
        transition: transform 0.3s ease;
    }
    
    .sidebar__post-image:hover img {
        transform: scale(1.05);
    }
    
    .sidebar__post-content h3 {
        margin: 0;
    }
    
    .panorama-preloader {
        z-index: 10;
    }
    
    #panorama-360.loaded .panorama-preloader {
        display: none !important;
    }
    
    /* Panorama spinner */
    .panorama-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e8ebef;
        border-top: 4px solid var(--theme-color1);
        border-radius: 50%;
        animation: panorama-spin 1s linear infinite;
    }
    
    @keyframes panorama-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Move fullscreen button to bottom right */
    #panorama-360 .pnlm-fullscreen-toggle,
    #panorama-360 .pnlm-controls .pnlm-fullscreen-toggle {
        position: absolute !important;
        top: auto !important;
        left: auto !important;
        bottom: 10px !important;
        right: 10px !important;
        margin: 0 !important;
    }
</style>

<!-- Pannellum 360 Viewer CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">

<script>
    // Force remove preloader
    document.addEventListener('DOMContentLoaded', function() {
        const preloader = document.querySelector('.preloader');
        if (preloader) {
            preloader.style.display = 'none';
            preloader.remove();
        }
    });
    
    // Also remove on window load as backup
    window.addEventListener('load', function() {
        const preloader = document.querySelector('.preloader');
        if (preloader) {
            preloader.style.display = 'none';
            preloader.remove();
        }
    });
    
     // Initialize bxslider with single image mode
     $(window).on('load', function() {
         var $slider = $('.product-details .bxslider');
         if ($slider.length) {
             // Destroy existing slider if any
             if ($slider.data('bxSlider')) {
                 $slider.destroySlider();
             }
             
             // Function to move active thumbnail to top
             function moveActiveThumbToTop(currentIndex) {
                 var $thumbBox = $('.product-details .slider-pager .thumb-box');
                 var $thumbItems = $thumbBox.find('li');
                 
                 // Remove active class from all first
                 $thumbItems.find('a').removeClass('active');
                 
                 // Find thumbnail by data-slide-index attribute (more reliable than eq)
                 var $activeThumb = $thumbItems.find('a[data-slide-index="' + currentIndex + '"]').closest('li');
                 
                 if ($activeThumb.length) {
                     // Add active class to current
                     $activeThumb.find('a').addClass('active');
                     
                     // If not already at top, move it
                     if (!$activeThumb.is(':first-child')) {
                         // Detach and prepend to move to top
                         $activeThumb.detach();
                         $thumbBox.prepend($activeThumb);
                         
                         // Scroll to top immediately
                         $thumbBox.scrollTop(0);
                     }
                 }
             }
             
             // Remove any existing event handlers to prevent duplicates
             $('.product-details .slider-pager .thumb-box').off('click', 'a');
             
             // Initialize with fade mode for single large image display
             var sliderInstance = $slider.bxSlider({
                 mode: 'fade',
                 auto: true,
                 autoHover: true,
                 pause: 1000,
                 speed: 500,
                 pagerCustom: '.product-details .slider-pager .thumb-box',
                 controls: false,
                 adaptiveHeight: false,
                 infiniteLoop: true,
                 useCSS: true,
                 easing: 'ease-in-out',
                 onSliderLoad: function(currentIndex) {
                     // Ensure thumbnails are visible and working
                     $('.product-details .slider-pager').show();
                     
                     // Move initial active thumbnail to top
                     setTimeout(function() {
                         moveActiveThumbToTop(currentIndex || 0);
                     }, 100);
                     
                     // Match thumbnail container height to slideshow height
                     function matchThumbnailHeight() {
                         var $sliderEl = $('.product-details .bxslider');
                         var $thumbnailCol = $('.product-details .image-gallery-wrapper .col-lg-2');
                         if ($sliderEl.length && $thumbnailCol.length) {
                             var sliderHeight = $sliderEl.outerHeight();
                             // Only set height if slider has a valid height (greater than 0)
                             if (sliderHeight && sliderHeight > 0) {
                                 $thumbnailCol.css({
                                     'height': sliderHeight + 'px',
                                     'min-height': sliderHeight + 'px'
                                 });
                             }
                         }
                     }
                     
                     // Run immediately and also after a short delay to ensure slider is fully rendered
                     matchThumbnailHeight();
                     setTimeout(matchThumbnailHeight, 100);
                     setTimeout(matchThumbnailHeight, 300);
                     
                     // Update on window resize (remove old handlers first)
                     $(window).off('resize.product-details-slider');
                     $(window).on('resize.product-details-slider', function() {
                         setTimeout(matchThumbnailHeight, 50);
                     });
                     
                     // Reinitialize media items for popup after slider loads
                     if (typeof initMediaItems === 'function') {
                         initMediaItems();
                     }
                 },
                 onSlideAfter: function($slideElement, oldIndex, newIndex) {
                     // Move active thumbnail to top when slide changes
                     // Use setTimeout to ensure slide transition is complete
                     var self = this;
                     setTimeout(function() {
                         moveActiveThumbToTop(newIndex);
                     }, 100);
                 }
             });
             
             // Handle thumbnail clicks - use event delegation
             $(document).off('click.product-details-thumbs', '.product-details .slider-pager .thumb-box a')
                        .on('click.product-details-thumbs', '.product-details .slider-pager .thumb-box a', function(e) {
                 e.preventDefault();
                 e.stopPropagation();
                 var slideIndex = parseInt($(this).data('slide-index'), 10);
                 if (!isNaN(slideIndex) && sliderInstance) {
                     sliderInstance.goToSlide(slideIndex);
                 }
                 return false;
             });
         }
     });
     
     // Load Pannellum and initialize 360 view if available
     <% if (currentItem && currentItem.view360) { %>
     $(document).ready(function() {
         function showError(container, message) {
             var preloader = container.querySelector('.panorama-preloader');
             if (preloader) {
                 preloader.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;"><p style="margin: 0; font-size: 14px;">' + message + '</p></div>';
                 preloader.style.display = 'flex';
             }
         }
         
         // Check WebGL support with detailed diagnostics
         function checkWebGLSupport() {
             try {
                 var canvas = document.createElement('canvas');
                 var gl = null;
                 
                 // Try WebGL 2.0 first
                 gl = canvas.getContext('webgl2');
                 if (gl) {
                     console.log('WebGL 2.0 supported');
                     return { supported: true, version: '2.0', context: gl };
                 }
                 
                 // Try WebGL 1.0
                 gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                 if (gl) {
                     console.log('WebGL 1.0 supported');
                     return { supported: true, version: '1.0', context: gl };
                 }
                 
                 return { supported: false, version: null, context: null };
             } catch(e) {
                 console.error('WebGL check error:', e);
                 return { supported: false, version: null, context: null, error: e.message };
             }
         }
         
         function initPannellumViewer() {
             var container = document.getElementById('panorama-360');
             if (!container) {
                 return;
             }
             
             // Check WebGL before loading Pannellum
             var webglCheck = checkWebGLSupport();
             if (!webglCheck.supported) {
                 showError(container, 'WebGL is not available. Please: 1) Enable hardware acceleration in Chrome (chrome://settings/system), 2) Check chrome://flags and enable "WebGL Draft Extensions", 3) Update your graphics drivers, 4) Try disabling browser extensions.');
                 return;
             }
             
             if (typeof pannellum === 'undefined') {
                 // Load Pannellum script dynamically
                 var script = document.createElement('script');
                 script.src = 'https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js';
                 script.onload = function() {
                     setTimeout(initPannellumViewer, 200);
                 };
                 script.onerror = function() {
                     showError(container, 'Failed to load 360 viewer. Please refresh the page.');
                 };
                 document.head.appendChild(script);
                 return;
             }
             
             try {
                 // Construct absolute URL for panorama image
                 var panoramaPath = "<%= currentItem.view360 %>";
                 var panoramaUrl = panoramaPath;
                 if (panoramaPath && !panoramaPath.startsWith('http://') && !panoramaPath.startsWith('https://')) {
                     // Convert relative path to absolute URL
                     panoramaUrl = window.location.origin + (panoramaPath.startsWith('/') ? panoramaPath : '/' + panoramaPath);
                 }
                 
                 console.log('Loading 360 view from:', panoramaUrl);
                 
                 // Preload image to verify it exists
                 var img = new Image();
                 img.onload = function() {
                     // Image loaded successfully, initialize Pannellum
                     var preloader = container.querySelector('.panorama-preloader');
                     if (preloader) {
                         preloader.style.display = 'none';
                     }
                     
                     try {
                         var viewer = pannellum.viewer('panorama-360', {
                             "type": "equirectangular",
                             "panorama": panoramaUrl,
                             "autoLoad": true,
                             "autoRotate": 0,
                             "compass": false,
                             "showControls": true,
                             "keyboardZoom": false,
                             "mouseZoom": false,
                             "draggable": true,
                             "disableKeyboardCtrl": true,
                             "hfov": 100,
                             "minHfov": 100,
                             "maxHfov": 100,
                             "pitch": 0,
                             "yaw": 0,
                             "showFullscreenCtrl": true,
                             "showZoomCtrl": false
                         });
                         
                         // Handle errors from Pannellum
                         if (viewer && viewer.on) {
                             viewer.on('error', function(error) {
                                 console.error('Pannellum error:', error);
                                 var errorMsg = 'Unable to load 360° view. ';
                                 if (error && error.message) {
                                     if (error.message.includes('WebGL')) {
                                         errorMsg = 'WebGL error: ' + error.message + '. Try: 1) Refresh page, 2) Clear cache, 3) Check chrome://flags for WebGL settings, 4) Update graphics drivers.';
                                     } else {
                                         errorMsg += error.message;
                                     }
                                 } else {
                                     errorMsg += 'Please try refreshing the page.';
                                 }
                                 showError(container, errorMsg);
                             });
                         }
                         
                         // Monitor for WebGL errors in the DOM
                         var errorCheckInterval = setInterval(function() {
                             var errorElement = container.querySelector('.pnlm-error');
                             if (errorElement && errorElement.textContent) {
                                 var errorText = errorElement.textContent.trim();
                                 if (errorText.includes('WebGL')) {
                                     clearInterval(errorCheckInterval);
                                     showError(container, 'WebGL error detected. Solutions: 1) Go to chrome://flags and search for "WebGL", enable all WebGL options, 2) Restart Chrome, 3) Clear browser cache, 4) Update graphics drivers.');
                                 }
                             }
                         }, 500);
                         
                         // Check if viewer loaded successfully
                         setTimeout(function() {
                             clearInterval(errorCheckInterval);
                             var viewerElement = container.querySelector('.pnlm-container');
                             var errorElement = container.querySelector('.pnlm-error');
                             
                             if (errorElement && errorElement.textContent) {
                                 var errorText = errorElement.textContent.trim();
                                 if (errorText.includes('WebGL')) {
                                     showError(container, 'WebGL is not working. Try: 1) chrome://flags - enable "WebGL Draft Extensions", 2) Restart Chrome, 3) Check chrome://gpu for WebGL status, 4) Update graphics drivers.');
                                 } else {
                                     showError(container, errorText || '360° view failed to load. Please refresh the page.');
                                 }
                             } else if (viewerElement && viewerElement.offsetHeight > 0) {
                                 container.classList.add('loaded');
                                 console.log('360 view initialized successfully');
                             }
                         }, 2000);
                         
                     } catch(e) {
                         console.error('Error initializing Pannellum:', e);
                         showError(container, 'Error initializing 360° viewer: ' + (e.message || 'Unknown error'));
                     }
                 };
                 
                 img.onerror = function() {
                     console.error('Failed to load image:', panoramaUrl);
                     showError(container, 'Image file not found: ' + panoramaPath + '. Please check if the file exists at: ' + panoramaUrl);
                 };
                 
                 img.src = panoramaUrl;
                 
             } catch(e) {
                 console.error('Error setting up 360 view:', e);
                 showError(container, 'Error loading 360° view: ' + (e.message || 'Unknown error') + '. Please refresh the page.');
             }
         }
         
         // Initialize after a short delay
         setTimeout(initPannellumViewer, 300);
     });
     <% } %>
</script>

<% if (youtubeVideoId) { %>
<!-- YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>

<script>
    // Detail banner YouTube player
    var detailBannerYouTubePlayer = null;
    var detailBannerVideoId = '<%= youtubeVideoId %>';
    
    // YouTube API ready callback
    function onYouTubeIframeAPIReady() {
        if (typeof detailBannerYouTubePlayer === 'undefined' || detailBannerYouTubePlayer === null) {
            setTimeout(initializeDetailBannerYouTubePlayer, 500);
        }
    }
    
    // Initialize detail banner YouTube player
    function initializeDetailBannerYouTubePlayer() {
        var container = document.getElementById('detail-banner-youtube-player');
        if (!container || detailBannerYouTubePlayer) {
            return;
        }
        
        detailBannerYouTubePlayer = new YT.Player('detail-banner-youtube-player', {
            videoId: detailBannerVideoId,
            width: '100%',
            height: '100%',
            playerVars: {
                'autoplay': 1,
                'mute': 1,
                'loop': 1,
                'playlist': detailBannerVideoId,
                'controls': 0,
                'rel': 0,
                'modestbranding': 1,
                'playsinline': 1,
                'vq': 'hd2160',
                'iv_load_policy': 3,
                'showinfo': 0,
                'fs': 0,
                'cc_load_policy': 0,
                'disablekb': 1,
                'enablejsapi': 1
            },
            'events': {
                'onReady': function(event) {
                    var player = event.target;
                    try {
                        var iframe = document.getElementById('detail-banner-youtube-player');
                        
                        try {
                            player.setPlaybackQuality('hd2160');
                            player.mute();
                            
                            setTimeout(function() {
                                player.setPlaybackQuality('hd2160');
                            }, 50);
                            setTimeout(function() {
                                player.setPlaybackQuality('hd2160');
                            }, 150);
                            setTimeout(function() {
                                player.setPlaybackQuality('hd2160');
                            }, 300);
                            
                            if (iframe && iframe.parentElement) {
                                var container = iframe.parentElement;
                                var blocker = container.querySelector('.youtube-overlay-blocker');
                                if (!blocker) {
                                    blocker = document.createElement('div');
                                    blocker.className = 'youtube-overlay-blocker';
                                    container.appendChild(blocker);
                                }
                                
                                // Find the actual YouTube iframe element
                                var youtubeIframe = container.querySelector('iframe');
                                if (youtubeIframe) {
                                    youtubeIframe.style.pointerEvents = 'none';
                                    
                                    youtubeIframe.style.backgroundImage = 'none';
                                    youtubeIframe.style.background = 'transparent';
                                    youtubeIframe.style.backgroundColor = 'transparent';
                                    youtubeIframe.style.backgroundSize = 'unset';
                                    youtubeIframe.style.backgroundPosition = 'unset';
                                    youtubeIframe.style.backgroundRepeat = 'unset';
                                    
                                    youtubeIframe.style.setProperty('background-image', 'none', 'important');
                                    youtubeIframe.style.setProperty('background', 'transparent', 'important');
                                    youtubeIframe.style.setProperty('background-color', 'transparent', 'important');
                                    youtubeIframe.style.setProperty('background-size', 'unset', 'important');
                                    youtubeIframe.style.setProperty('background-position', 'unset', 'important');
                                    youtubeIframe.style.setProperty('background-repeat', 'unset', 'important');
                                    
                                    // Force scale 1.6 on iframe
                                    youtubeIframe.style.setProperty('transform', 'translateZ(0) scale(1.6)', 'important');
                                    youtubeIframe.style.setProperty('-webkit-transform', 'translateZ(0) scale(1.6)', 'important');
                                    youtubeIframe.style.setProperty('transform-origin', 'center center', 'important');
                                    youtubeIframe.style.setProperty('-webkit-transform-origin', 'center center', 'important');
                                }
                            }
                            
                            setInterval(function() {
                                try {
                                    if (player.getPlayerState() === YT.PlayerState.PAUSED) {
                                        player.playVideo();
                                    }
                                    player.mute();
                                } catch(e) {
                                }
                            }, 500);
                        } catch(e) {
                        }
                    } catch(e) {
                    }
                },
                'onStateChange': function(event) {
                    var player = event.target;
                    
                    if (event.data === YT.PlayerState.PAUSED) {
                        try {
                            player.playVideo();
                        } catch(e) {
                        }
                    }
                    if (event.data === YT.PlayerState.BUFFERING || 
                        event.data === YT.PlayerState.CUED || 
                        event.data === YT.PlayerState.PLAYING) {
                        try {
                            player.setPlaybackQuality('hd2160');
                            player.mute();
                        } catch(e) {
                        }
                    }
                },
                'onPlaybackQualityChange': function(event) {
                    if (event.data !== 'hd2160' && event.data !== 'highres') {
                        try {
                            event.target.setPlaybackQuality('hd2160');
                        } catch(e) {
                        }
                    }
                }
            }
        });
    }
    
    if (typeof YT !== 'undefined' && YT.Player) {
        onYouTubeIframeAPIReady();
    }
    
    // Prevent interactions
    document.addEventListener('contextmenu', function(e) {
        if (e.target.closest('.banner-youtube-container')) {
            e.preventDefault();
            return false;
        }
    }, false);
    
    document.addEventListener('keydown', function(e) {
        if (e.target.closest('.banner-youtube-container') || 
            (e.key === ' ' || e.key === 'k' || e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
            if (document.activeElement && document.activeElement.closest('.banner-youtube-container')) {
                e.preventDefault();
                return false;
            }
        }
    }, false);
    
    document.addEventListener('dragstart', function(e) {
        if (e.target.closest('.banner-youtube-container')) {
            e.preventDefault();
            return false;
        }
    }, false);
    
    // Ensure banner YouTube container has overlays and blocked interactions
    function enforceDetailBannerYouTubeBlocking() {
        var container = document.querySelector('#detail-banner-youtube-player');
        if (!container) return;
        
        var iframe = container.querySelector('iframe');
        if (iframe) {
            iframe.style.pointerEvents = 'none';
            
            iframe.style.setProperty('background-image', 'none', 'important');
            iframe.style.setProperty('background', 'transparent', 'important');
            iframe.style.setProperty('background-color', 'transparent', 'important');
            iframe.style.setProperty('background-size', 'unset', 'important');
            iframe.style.setProperty('background-position', 'unset', 'important');
            iframe.style.setProperty('background-repeat', 'unset', 'important');
            
            iframe.style.backgroundImage = 'none';
            iframe.style.background = 'transparent';
            iframe.style.backgroundColor = 'transparent';
            iframe.style.backgroundSize = 'unset';
            iframe.style.backgroundPosition = 'unset';
            iframe.style.backgroundRepeat = 'unset';
            
            iframe.removeAttribute('data-background-image');
            
            // Force scale 1.6 on iframe
            iframe.style.setProperty('transform', 'translateZ(0) scale(1.6)', 'important');
            iframe.style.setProperty('-webkit-transform', 'translateZ(0) scale(1.6)', 'important');
            iframe.style.setProperty('transform-origin', 'center center', 'important');
            iframe.style.setProperty('-webkit-transform-origin', 'center center', 'important');
            
            var blocker = container.querySelector('.youtube-overlay-blocker');
            if (!blocker) {
                blocker = document.createElement('div');
                blocker.className = 'youtube-overlay-blocker';
                container.appendChild(blocker);
            }
            blocker.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100000; pointer-events: auto !important; background: transparent; cursor: default;';
        }
    }
    
    enforceDetailBannerYouTubeBlocking();
    setTimeout(enforceDetailBannerYouTubeBlocking, 100);
    setTimeout(enforceDetailBannerYouTubeBlocking, 500);
    setTimeout(enforceDetailBannerYouTubeBlocking, 1000);
    setInterval(enforceDetailBannerYouTubeBlocking, 2000);
    
    if (window.MutationObserver) {
        var observer = new MutationObserver(function(mutations) {
            enforceDetailBannerYouTubeBlocking();
        });
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }
</script>
<% } %>
